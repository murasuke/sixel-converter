# Sixel画像コンバーター

## はじめに

Windows Terminal(1.22)で、遂にSixelグラフィックスがサポートされました。
全く最適化は行わない、シンプルなコンバーターを作成しました

## Sixelグラフィックスとは
特別なエスケープシーケンスをキャラクターベースのターミナルに送信することで、画像を表示する技術です。

[Sixel グラフィックス - VT100.net: VT330/VT340 プログラマーリファレンスマニュアル](https://github.com/fumiyas/translation-ja/blob/master/vt3xx-sixel.md)

Sixel データ文字 は、 ? (0x3F) から ~ (0x7E) の範囲の文字で、1文字あたり縦に6ピクセル分の出力を行います
* ? (0x3F) -> 000000
* @ (0x40) -> 000001
* A (0x41) -> 000010
* t (0x74) -> 110101
* ~ (0x7E) -> 111111

※最下位ビットが上に表示される。`@`は6ピクセルのうち一番上のピクセルを出力する


* **カラーパレット:** 複数の色を定義し、それぞれの色に番号を割り当てます。このプログラムでは、216色のカラーパレットを使用しています。



## 説明

このNode.jsスクリプトは、入力として画像ファイルを受け取り、Sixelグラフィックスを使用してターミナルに表示します。

その仕組みは以下の通りです。

1.  指定された画像ファイルを読み込みます。
2.  `node-canvas` を使用して、画像のピクセルデータにアクセスします。
3.  各ピクセルの色を216色のWebセーフカラーパレットに減色します。
4.  減色されたピクセルデータをSixelグラフィックス文字列に変換します。

## 機能

* `node-canvas` がサポートするさまざまな画像形式（例：PNG、JPEG）を読み込みます。
* ターミナル間の互換性を高めるため、画像の色を216色のWebセーフカラーパレットに減色します。
* Sixel規格をサポートするターミナルで表示できるSixelグラフィックス出力を生成します。

## 使用方法

このスクリプトを使用するには、Node.jsがインストールされている必要があります。ターミナルを開き、`sixelConverter.ts` を保存したディレクトリに移動します。次に、コマンドライン引数として画像ファイルへのパスを指定してスクリプトを実行します。

```bash
node sixelConverter.js <画像ファイル>
```

`<画像ファイル>` を実際の画像ファイルへのパス（例：`image.png`、`path/to/my_image.jpg`）に置き換えてください。

**例:**

```bash
node sixelConverter.js my_picture.png
```

スクリプトは、画像のSixel表現をターミナルに出力します。

**デバッグオプション:**

オプションで、2番目の引数として `-d` を渡すと、カラーデータ、カラーマップ、およびエスケープシーケンスがエスケープされたSixel文字列を含むデバッグ情報が出力されます。

```bash
node sixelConverter.js my_picture.png -d
```

## 依存関係

このスクリプトは、以下のNode.jsモジュールに依存しています。

* **node-canvas**: 画像の読み込みとピクセルデータへのアクセスに使用されます。

## インストール

スクリプトを実行する前に、必要な依存関係をインストールする必要があります。システムにNode.jsとnpm（Node Package Manager）がインストールされていることを確認してください。次に、スクリプトのディレクトリでターミナルを開き、以下を実行します。

```bash
npm install canvas
```

または

```bash
yarn add canvas
```

## 注意事項

* **Windowsターミナル:** Windowsターミナルでは、Node.jsの実行時に拡張子 `.exe` を明示的に指定する必要がある場合があります。
    ```bash
    node.exe sixelConverter.js <画像ファイル>
    ```
* **Sixelサポート:** 出力を正しく表示するには、ターミナルエミュレータがSixelグラフィックス規格をサポートしている必要があります。多くの最新のターミナル（Linuxディストリビューションや一部のmacOSターミナルなど）はSixelをサポートしています。
* **簡略化されたSixelエンコード:** 現在の `convertToSixel` 関数の実装は、Sixelエンコードの簡略化された例を提供しています。各ピクセルに対してパレット番号とビットパターンを表す文字を出力します。より完全なSixelエンコーダーは通常、6つの垂直ピクセルを1つの文字で表現し、より効率的なエンコードを実現します。
* **色の量子化:** スクリプトは色を216色のWebセーフカラーパレットに減色します。これにより、元の画像と比較して色の忠実度が低下する可能性があります。
* **パフォーマンス:** 非常に大きな画像の場合、処理に時間がかかることがあります。
