# Sixel画像コンバーター

## はじめに

Windows Terminal(1.22)で、遂にSixelグラフィックスがサポートされました

実際に画像が表示できるかを確認するため、画像をSixel Graphics形式に変換するプログラムを作成します

### プログラムの概要

`sixelConverter.ts`スクリプトは、画像ファイルを読み込み、そのピクセルデータを処理してSixel Graphics文字列に変換します。この文字列はSixel Graphicsをサポートするターミナルに出力でき、ターミナル内で直接画像を表示することができます。

node環境には`canvas`がないため、`node-canvas`モジュールのインストールが必要です

## Sixelグラフィックスとは
特別なエスケープシーケンスをターミナルに送信することで、画像を表示する技術です
特定の文字を送信することで、文字に対応した縦に6ピクセルの画像を出力することができます

色の指定は文字毎(6ピクセルまとめて)しか行えないため、1ピクセル毎に色を指定して画像を表示していきます

[Sixel グラフィックス - VT100.net: VT330/VT340 プログラマーリファレンスマニュアル](https://github.com/fumiyas/translation-ja/blob/master/vt3xx-sixel.md)

### 画像を表示するエスケープシーケンスの構造について

* 全体の構成は下記のようになっています

  `Sixel開始シーケンス,アスペクト比,解像度の指定,カラーパレットの定義,Sixelデータ文字,終了シーケンス`

   * 開始シーケンス、アスペクト比、解像度の指定 は固定なので後述のサンプルを参照

## カラーパレット

カラーパレットは色番号(0～255)とそれに対応した色を定義します。ピクセルの描画を行う際は色番号を指定して出力を行います

`#0(色番号);2(RGB指定);(red;green;blue)#1(色番号);2(RGB指定);(red;green;blue)#2・・・`

`#0;2;102;0;0#1;2;0;0;102`

## Sixelデータ文字について

Sixelデータ文字 は、 ? (0x3F) から ~ (0x7E) の範囲の文字です。
直前で指定された色で、縦に6ピクセル分の出力を行います。

| ? (0x3F) | @ (0x40) | A (0x41) | B (0x42) | C (0x43)  |～| ~ (0x7E) |
| ---- | ---- | ---- | ---- | ---- |---- | ---- |
| 000000 | 000001 | 000010 | 000011 | 000100 |～| 111111 |


* `@`は上下6ピクセルのうち一番上のピクセルを、`~`は6ピクセル全てを塗りつぶします

* 塗りつぶしをしないピクセルは`透明`扱いです。既に塗りつぶされたピクセルの色を上書きしません


![alt text](img/sixel-char.png)



6ピクセル別々の色を出力するためには、描画が重ならない文字 `@` ⇒ `A` ⇒ `C` ⇒ `G` ⇒ `O` ⇒ `_` を順に描画します

### 2×2の画像を描画するサンプル

一番上を塗りつぶす`@`と、2ピクセル目を塗りつぶす`A`を使い、色の指定と左右の位置を行いながら描画していきます

![alt text](img/image.png)

赤(左上@)⇒青(右上@)⇒先頭に戻る($)⇒緑(左下A)⇒白(右下A)の順に1pixelずつ描画


![alt text](image.png)
  `\x1BPq"1;1;96;96#1;2;102;0;0#2;2;0;0;102#3;2;0;102;0#4;2;102;102;102#1@#2@$#3A#4A$\x1B\`

| 文字シーケンス| 概要 | 補足 |
| ---- | ---- |  ---- |
| `\x1BPq` | Sixel開始シーケンス | ESC(\x1B) + 'Pq'  |
| `"1;1;96;96`| アスペクト比1:1、解像度96dpi x 96dpi |  |
| #1;2;102;0;0 | カラーパレットの定義(#1,赤) |  #1(色番号);2(RGB指定);(red;green;blue) |
| #2;2;0;0;102 | カラーパレットの定義(#2,緑) | 〃 |
| #3;2;0;102;0 | カラーパレットの定義(#3,青) | 〃 |
| #4;2;102;102;102 | カラーパレットの定義(#4,灰) |  |
| #1@ | #1で@を描画(して右に1ピクセルずれる) | @は縦に6pixelのうち先頭1pxのみ |
| #2@ | #2で@を描画(して右に1ピクセルずれる) | 〃 |
| $ | 描画位置を行頭に戻す | `$-`は次の行(6pixel下)の先頭へ移動 |
| #3A | #3でAを描画(して右に1ピクセルずれる) | Aは縦に6pixelのうち2px目のみ |
| #4A |  #3でAを描画(して右に1ピクセルずれる) | 〃 |
| \x1B\ | Sixel終了シーケンス |  ESC(\x1B) + '/' |


## 説明

このNode.jsスクリプトは、入力として画像ファイルを受け取り、Sixelグラフィックスを使用してターミナルに表示します。

その仕組みは以下の通りです。

1.  指定された画像ファイルを読み込みます。
2.  `node-canvas` を使用して、画像のピクセルデータにアクセスします。
3.  各ピクセルの色を216色のWebセーフカラーパレットに減色します。
4.  減色されたピクセルデータをSixelグラフィックス文字列に変換します。


この`sixelConverter.ts`スクリプトは、入力として画像ファイルを受け取り、Sixelグラフィックスを使用してターミナルに表示します。

仕組みは以下の通りです

1. **imageLoader**: 画像ファイルを読み込み、Canvasを使用してそのピクセルデータを取得します。
1. **reductionColor**: 画像の色を216色のWebセーフパレットに減色します。
1. **convertToSixel**: 減色されたデータをSixel Graphics文字列に変換します。
1. **main**: 画像の読み込み、色の減少、Sixel変換プロセスを調整するメイン関数です。


## 使用方法


```bash
npx tsx sixelConverter.ts <画像ファイルパス>
```

**デバッグオプション:**

オプションで、2番目の引数として `-d` を渡すと、カラーデータ、カラーマップ、およびエスケープシーケンスがエスケープされたSixel文字列を含むデバッグ情報を出力します

```bash
npx tsx sixelConverter.ts my_picture.png -d
```

## 依存関係

このスクリプトは、以下のNode.jsモジュールに依存しています。

* **node-canvas**: 画像の読み込みとピクセルデータへの変換に利用します
* **tsx**: TypeScriptファイルをそのまま実行するために使用します


## インストール

Node.jsとnpmがインストール済みであることを前提として、以下を実行します。

```bash
npm install canvas
```

または

```bash
yarn add canvas
```

## 注意事項

* **Windowsターミナル:** Windowsターミナルでは、Node.jsの実行時に拡張子 `.exe` を明示的に指定する必要がある場合があります。
    ```bash
    node.exe sixelConverter.js <画像ファイル>
    ```
* **Sixelサポート:** 出力を正しく表示するには、ターミナルエミュレータがSixelグラフィックスをサポートしている必要があります
* **パフォーマンス:** 最適化が不十分なため、処理に時間がかかる場合があります
